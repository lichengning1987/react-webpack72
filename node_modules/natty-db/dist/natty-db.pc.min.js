!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("NattyDB",[],t):"object"==typeof exports?exports.NattyDB=t():e.NattyDB=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";e.exports=r(1)},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(2),i=r(3),c=r(5),u=r(4),s=r(6),l=u.extend,f=u.runAsFn,d=u.isAbsoluteUrl,p=u.isRelativeUrl,m=u.noop,v=u.isBoolean,h=u.isNumber,y=u.isArray,g=u.isFunction,b=(u.each,null),x="",j=!0,k=!j,w={dummy:j};w.then=w["catch"]=w["finally"]=function(){return w};var _={cache:!1,data:{},didRequest:m,fit:m,header:{},ignoreSelfConcurrent:k,jsonp:k,log:k,method:"GET",mock:k,mockUrl:x,mockUrlPrefix:x,process:m,retry:0,request:b,timeout:0,traditional:k,url:x,urlPrefix:x,withCredentials:b,willRequest:m},q=l({},_),R=function(){function e(t,r,o){n(this,e);var a=this;a.context=o,a.cache={},a.name=t;for(var i in r)a[i]=a.createAPI(l({DBName:t,API:i},f(r[i])))}return o(e,[{key:"processAPIOptions",value:function(e){var t=this,r=l({},t.context,e);return r.pending=k,r.mock&&(r.method="GET",r.mockUrl=t.getFullUrl(r.mockUrl,!0)),r.url=t.getFullUrl(e.url),y(e.jsonp)&&(r.jsonp=v(e.jsonp[0])?e.jsonp[0]:k,r.jsonp&&(r.jsonpFlag=e.jsonp[1],r.jsonpCallbackName=e.jsonp[2])),!r.mock&&r.url.match(/\.jsonp(\?.*)?$/)&&(r.jsonp=!0),r}},{key:"createAPI",value:function(e){var t=this,r=t.processAPIOptions(e),n=function(e){return r.ignoreSelfConcurrent&&r.pending?w:0===r.retry?t.request(e,r):t.tryRequest(e,r)};return n.config=r,t.addLoopSupport(n),n}},{key:"addLoopSupport",value:function(e){var t=null;e.looping=k,e.startLoop=function(r){var n=arguments.length<=1||void 0===arguments[1]?m:arguments[1],o=arguments.length<=2||void 0===arguments[2]?m:arguments[2];if(!r.duration||!h(r.duration))throw new Error("Illegal `duration` value for `startLoop` method.");var a=function i(){e.looping=j,t=setTimeout(function(){e(r.data).then(n,o),i()},r.duration)};e(r.data).then(n,o),a()},e.stopLoop=function(){clearTimeout(t),e.looping=k,t=null}}},{key:"getFullUrl",value:function(e,t){if(!e)return x;var r=t?"mockUrlPrefix":"urlPrefix";return!this.context[r]||d(e)||p(e)?e:this.context[r]+e}},{key:"request",value:function(e,t,r){var n=this;t.overrideSelfConcurrent&&t._lastRequester&&(t._lastRequester.abort(),delete t._lastRequester);var o={mark:{__api:n.name+"."+t.API}};o.mark.__retryTime=r,t.mock&&(o.m=1),e=l({},t.data,f(e)),o.data=e,t.pending=j,t.willRequest(o,t);var i=new a;return t.request?o.requester=t.request(o,t,i):t.jsonp?o.requester=n.sendJSONP(o,t,i):o.requester=n.sendAjax(o,t,i),t.overrideSelfConcurrent&&(t._lastRequester=o.requester),0!==t.timeout&&setTimeout(function(){if(t.pending){o.requester.abort(),delete o.requester;var e={timeout:j,message:"Timeout By "+t.timeout+"ms."};i.reject(e),s.fire("g.reject",[e,t]),s.fire(t._contextId+".reject",[e,t]),t.didRequest(o,t)}},t.timeout),i.promise}},{key:"tryRequest",value:function(e,t){var r=this,n=new a,o=0,i=function c(){r.request(e,t,o).then(function(e){n.resolve(e),s.fire("g.resolve",[e,t],t),s.fire(t._contextId+".resolve",[e,t],t)},function(e){o===t.retry?n.reject(e):(o++,c())})};return i(),n.promise}},{key:"processResponse",value:function(e,t,r,n){if(t.didRequest(e,t),n=t.fit(n,e),n.success){var o=t.process(n.content,e);r.resolve(o),s.fire("g.resolve",[o,t],t),s.fire(t._contextId+".resolve",[o,t],t)}else{var a=l({message:"Processing Failed: "+t.DBName+"."+t.API},n.error);r.reject(a),s.fire("g.reject",[a,t]),s.fire(t._contextId+".reject",[a,t])}}},{key:"sendAjax",value:function(e,t,r){var n=this;return i({traditional:t.traditional,cache:t.cache,mark:e.mark,log:t.log,url:t.mock?t.mockUrl:t.url,method:t.method,data:e.data,header:t.header,withCredentials:t.withCredentials,accept:"json",success:function(o){n.processResponse(e,t,r,o)},error:function(e){var t=void 0;switch(e){case 404:t="Not Found";break;case 500:t="Internal Server Error";break;default:t="Unknown Server Error"}r.reject({status:e,message:t})},complete:function(){void 0!==e.retryTime&&e.retryTime!==t.retry||(t.pending=k,e.requester=b,t.overrideSelfConcurrent&&delete t._lastRequester)}})}},{key:"sendJSONP",value:function(e,t,r){var n=this;return c({traditional:t.traditional,log:t.log,mark:e.mark,url:t.mock?t.mockUrl:t.url,data:e.data,cache:t.cache,flag:t.jsonpFlag,callbackName:t.jsonpCallbackName,success:function(o){n.processResponse(e,t,r,o)},error:function(e){r.reject({message:"Not Accessable JSONP `"})},complete:function(){void 0!==e.retryTime&&e.retryTime!==t.retry||(t.pending=k,e.requester=b,t.overrideSelfConcurrent&&delete t._lastRequester)}})}}]),e}(),N=function(){function e(t){n(this,e);var r=this;t=t||{};var o="c"+e.count++;r.contextId=o,r.config=l({},q,t,{_contextId:o})}return o(e,[{key:"create",value:function(e,t){var r=this;if(r[e])throw new Error('DB: "'+e+'" is existed! ');return r[e]=new R(e,t,r.config)}},{key:"on",value:function(e,t){return g(t)?(s.on(this.contextId+"."+e,t),this):void 0}}]),e}();N.count=0;var C=void 0;C="1.0.2";var S={onlyForHTML5:k,version:C,Context:N,_util:u,_event:s,ajax:i,jsonp:c,setGlobal:function(e){return q=l({},_,e),this},getGlobal:function(e){return e?q[e]:q},on:function(e,t){return g(t)?(s.on("g."+e,t),this):void 0}};S.setGlobal(_),e.exports=S},function(e,t){"use strict";function r(){var e=this;e.promise=new Promise(function(t,r){e._resolve=t,e._reject=r})}r.prototype.resolve=function(e){this._resolve.call(this.promise,e)},r.prototype.reject=function(e){this._reject.call(this.promise,e)},e.exports=r},function(e,t,r){"use strict";var n=r(4),o=n.extend,a=n.appendQueryString,i=n.noop,c=n.isCrossDomain,u=n.isBoolean,s=n.param,l="undefined"!=typeof window,f=(l?document:null,!1),d="undefined",p=null,m="GET",v="script",h="xml",y="text",g="json",b=d!==typeof XMLHttpRequest?new XMLHttpRequest:{},x=d!==typeof XDomainRequest,j=l?!("withCredentials"in b)&&x:null,k=l?"withCredentials"in b||x:null,w={"*":"*/*",script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript",json:"application/json, text/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},_=function(e,t){if(e.setRequestHeader){var r={Accept:w[t.accept]};c(t.url)||(r["X-Requested-With"]="XMLHttpRequest"),o(r,t.header),"POST"!==t.method||t.header["Content-Type"]||(r["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8");for(var n in r)e.setRequestHeader(n,r[n])}},q=function(e,t,r){var n=function(){e.__completed||(e.__completed=!0,t.complete(e.status,e),e.__aborted=null,delete e.__aborted)},o=function(){var r=e.responseText;switch(t.accept){case g:try{r=JSON.parse(r)}catch(o){console.warn("The response can NOT be parsed to JSON object.",r)}break;case v:(0,eval)(r);break;case h:r=e.responseXML}t.success(r,e),n()},a=function(){t.error(e.status,e),n()},c=function(){e.__completed||(t.abort(e.status,e),n())};j&&r?e.onload=o:e.onreadystatechange=function(){4==e.readyState&&(e.status>=200&&e.status<300||304===e.status?o():!e.__aborted&&a())},e.onerror=a;var u=e.abort;e.abort=function(){e.__aborted=!0,u.call(e),c()},e.onprogress=e.ontimeout=i},R={url:"",mark:{},method:m,accept:y,data:null,header:{},withCredentials:p,cache:!0,success:i,error:i,complete:i,abort:i,log:f,traditional:f},N=function(e){e=o({},R,e);var t=c(e.url);t&&(e.header={});var r=new XMLHttpRequest;return j&&t&&(r=new XDomainRequest),r.__completed=f,q(r,e,t),r.open(e.method,a(e.url,o({},e.mark,e.method===m?e.data:{}),e.cache,e.traditional)),j||(r.withCredentials=u(e.withCredentials)?e.withCredentials:t),_(r,e),r.send(e.method===m?p:e.data!==p?s(e.data,e.traditional):p),r};N.fallback=j,N.supportCORS=k,e.exports=N},function(e,t,r){"use strict";var n="undefined"!=typeof window,o=n?document:null,a=encodeURIComponent,i=null,c=Object.prototype.toString,u="[object Array]",s="[object Object]",l=n&&(!!window.ActiveXObject||"ActiveXObject"in window),f=function(e){return e},d=function(e){return function(){for(var t=arguments,r=e(t[0],t[1]),n=2,o=t.length;o>n;n++)r=e(r,t[n]);return r}},p=Math.random,m=Math.floor,v=function(){return m(9e9*p())},h=/^(https?:)?\/\//,y=function(e){return!!e.match(h)},g=/^[\.\/]/,b=function(e){return!!e.match(g)},x="boolean",j=function(e){return typeof e===x},k="function",w=function(e){return typeof e===k},_=function(e){return w(e)?e():e},q="number",R=function(e){return!isNaN(e)&&typeof e===q},N="object",C=function(e){return typeof e===N},S=function(e){return e!==i&&e===e.window},O=function(e){return e!==i&&C(e)&&!S(e)&&Object.getPrototypeOf(e)===Object.prototype},A=Array.isArray;A||(A=function(e){return c.call(e)===u});var T=void 0;o&&(T=o.createElement("a"),T.href=location.href);var P=function(e){var t=o.createElement("a");return t.href=e,!l||":"!==t.protocol&&""!==t.protocol?T.hostname!==t.hostname||T.port!==t.port||T.protocol!==t.protocol:""===t.hostname?!1:T.hostname!==t.hostname||T.port!==t.port},I=function X(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];for(var r in t)t.hasOwnProperty(r)&&void 0!==t[r]&&(A(t[r])?e[r]=[].concat(t[r]):O(t[r])?e[r]=X({},t[r]):e[r]=t[r]);return e},U=function(e){return e?typeof e.length===q:!1},E=function(e,t){var r=void 0,n=void 0;if(U(e)){for(r=0,n=e.length;n>r;r++)if(t.call(e[r],e[r],r)===!1)return}else for(r in e)if(t.call(e[r],e[r],r)===!1)return},F=function M(e,t,r,n){var o=void 0,a=A(t),i=O(t);E(t,function(t,l){o=c.call(t),n&&(l=r?n:n+"["+(i||o==s||o==u?l:"")+"]"),!n&&a?e.add(t.name,t.value):o==u||!r&&o==s?M(e,t,r,l):e.add(l,t)})},B=function(e,t){var r=[];return r.add=function(e,t){w(t)&&(t=t()),t==i&&(t=""),r.push(a(e)+"="+a(t))},F(r,e,t),r.join("&").replace(/%20/g,"+")},L=function(e){return decodeURIComponent(e.replace(/\+/g," "))},D=function(e,t,r,n){r||(t.__noCache=v());var o=B(t,n);return o?e+(~e.indexOf("?")?"&":"?")+o:e};e.exports={isIE:l,extend:d(I),each:E,makeRandom:v,appendQueryString:D,noop:f,isCrossDomain:P,isAbsoluteUrl:y,isRelativeUrl:b,isBoolean:j,isFunction:w,isNumber:R,isArray:A,param:B,decodeParam:L,runAsFn:_}},function(e,t,r){"use strict";function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var o=r(4),a=o.appendQueryString,i=o.noop,c=o.extend,u=o.makeRandom,s="undefined"!=typeof window,l=s?window:null,f=s?document:null,d=null,p="script",m=!1,v=s?navigator.userAgent.indexOf("MSIE 8.0")>-1:!1,h=function(e){v&&e.readyState?e.onreadystatechange=d:e.onerror=d,e.parentNode.removeChild(e),e=d},y=d,g=function(e,t){var r=f.createElement(p);return r.type="text/javascript",r.src=e,r.async=!0,v&&r.readyState?r.onreadystatechange=function(){"loaded"===r.readyState&&l[t.callbackName]&&(l[t.callbackName]=d,t.error(),t.complete())}:r.onerror=function(e){l[t.callbackName]=d,t.error(e),t.complete()},y=y||f.getElementsByTagName("head")[0],y.insertBefore(r,y.firstChild),r},b={url:"",mark:{},data:{},cache:!0,success:i,error:i,complete:i,log:!1,flag:"callback",callbackName:"jsonp{id}",traditional:m},x=function(e){e=c({},b,e);var t=e.callbackName=e.callbackName.replace(/\{id\}/,u()),r=e.complete,o=void 0;e.complete=function(){h(o),r()},l[t]=function(r){l[t]=d,e.success(r),e.complete()};var i=a(e.url,c(n({},e.flag,t),e.mark,e.data),e.cache,e.traditional);return o=g(i,e),{abort:function(){l[t]=function(){l[t]=d},h(o)}}};e.exports=x},function(e,t){"use strict";function r(e){return n+e}var n="__",o={on:function(){var e=this,t=arguments;if("string"==typeof t[0]&&"function"==typeof t[1]){var n=r(t[0]);e[n]=e[n]||[],e[n].push(t[1])}else if("object"==typeof t[0]){var o=t[0];for(var a in o)e.on(a,o[a])}},off:function(e,t){var n=this,e=r(e);if(t){var o=n[e];o.splice(o.indexOf(t),1),n[e].length||delete n[e]}else delete n[e]},fire:function(e,t,n){var o=this,a=o[r(e)];if(!a)return"NO_EVENT";for(var i,c=0;i=a[c];c++)i.apply(n||o,[].concat(t))},hasEvent:function(e){return!!this[r(e)]}};e.exports=o}])});